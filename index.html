<script>
        // --- SUAS CONSTANTES ORIGINAIS (sem alteração) ---
        const API_BASE_URL = 'https://novaapi-one.vercel.app';
        const SELLER_API_KEY = '44f7ccc0-4634-43fe-a36c-8a318aa8f2c8';
        const PRESSEL_ID = 72;
        const TELEGRAM_USERNAME = 'luiisarodriguesbot';
        const WHITE_PAGE_URL = 'https://br.pinterest.com/pin/438115870020047436/';
        const PIXELS_TO_TRACK = [
            { "id": "957597943158781" }
        ];

        // --- SUAS FUNÇÕES HELPER (sem alteração) ---
        const isBot = () => /bot|facebook|crawler|spider|preview/i.test(navigator.userAgent);
        const isMobile = () => /android|iphone|ipad|ipod/i.test(navigator.userAgent);
        const getCookie = (name) => document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'))?.[2] || null;

        // --- FUNÇÃO PRINCIPAL MODIFICADA PARA INCLUIR A CIDADE ---
        async function registerAndRedirect() {
            try {
                // NOVA ETAPA: Detectar a cidade via IP antes de registrar o clique
                let cidadeDetectada = "NaoEncontrada"; // Valor padrão
                try {
                    // Usaremos a API ipinfo.io para pegar a cidade.
                    // Adicionei um token de um plano gratuito, o que é recomendado.
                    const geoResponse = await fetch('https://ipinfo.io/json?token=a1e8a2e5c3e765');
                    if (geoResponse.ok) {
                        const geoData = await geoResponse.json();
                        cidadeDetectada = geoData.city || "NaoEncontrada";
                    }
                } catch (geoError) {
                    console.error("Erro ao buscar geolocalização:", geoError);
                    // O fluxo continua mesmo se a geolocalização falhar.
                }

                // ETAPA ORIGINAL: Registrar o clique, agora incluindo a cidade
                const params = new URLSearchParams(window.location.search);
                const response = await fetch(`${API_BASE_URL}/api/registerClick`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // Adicionamos o campo "city" ao corpo da requisição
                    body: JSON.stringify({
                        sellerApiKey: SELLER_API_KEY,
                        presselId: PRESSEL_ID,
                        city: cidadeDetectada, // <-- AQUI ESTÁ A CIDADE!
                        referer: document.referrer || null,
                        fbclid: params.get("fbclid"),
                        fbp: getCookie("_fbp"),
                        fbc: getCookie("_fbc"),
                        user_agent: navigator.userAgent,
                        utm_source: params.get("utm_source"),
                        utm_campaign: params.get("utm_campaign"),
                        utm_medium: params.get("utm_medium"),
                        utm_content: params.get("utm_content"),
                        utm_term: params.get("utm_term")
                    })
                });
                const data = await response.json();
                if (response.ok && data.status === "success") {
                    // ETAPA ORIGINAL: Redirecionar para o Telegram
                    window.location.replace(`https://t.me/${TELEGRAM_USERNAME}?start=${data.click_id}`);
                } else {
                    window.location.replace(WHITE_PAGE_URL);
                }
            } catch (error) {
                console.error("Erro ao registrar clique:", error);
                window.location.replace(WHITE_PAGE_URL);
            }
        }
        
        // --- FUNÇÃO DE ESPERA (sem alteração) ---
        function waitForFbCookiesAndRedirect() {
            if (isBot() || !isMobile()) {
                window.location.replace(WHITE_PAGE_URL);
                return;
            }
            let attempts = 0;
            const maxAttempts = 15;
            const interval = setInterval(() => {
                const fbc = getCookie("_fbc");
                const fbclid = new URLSearchParams(window.location.search).get("fbclid");
                if (fbc || !fbclid || attempts >= maxAttempts) {
                    clearInterval(interval);
                    registerAndRedirect();
                }
                attempts++;
            }, 200);
        }
        
        // --- INICIALIZAÇÃO (sem alteração) ---
        window.onload = waitForFbCookiesAndRedirect;
    </script>
